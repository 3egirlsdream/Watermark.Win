@page "/"
@using Components.Layout
@using Watermark.Andorid.Models
@using Watermark.Razor
@using Watermark.Shared.Enums
@using Watermark.Shared.Models
@using Watermark.Win.Models
@inject IWMWatermarkHelper helper
@inject APIHelper api
@inject NavigationManager navigationManager
@inject IJSRuntime JSRuntime
@inherits PStackPageBase
@inject IPopupService PopupService
@inject PageStackNavController NavController
@layout MainLayout

<div style="height:100%;">
    <MTabs SliderColor="black" @bind-Value="tab" Height="30" ShowArrows="false" Centered>
        @foreach (var e in tab1Head)
        {
            <MTab Value="e">
                @e
            </MTab>
        }
    </MTabs>
    <div style="@($"height: calc(100% - 30px);")">
        <MSwiper AutoHeight SpaceBetween="24" Index="tab1Head.IndexOf(tab.ToString())" IndexChanged="@((e) => tab = tab1Head[e])">
            <MSwiperSlide>
                <MudPaper Elevation="0" Style="padding: 8px 18px;height: 100%;overflow: auto;scrollbar-width: none;">
                    <MudGrid Class="pt-2" Justify="Justify.FlexStart">
                        @if (loading_down)
                        {
                            <MudProgressCircular Color="Color.Secondary" Indeterminate="true" Style="margin-left:calc(50% - 20px);margin-top:calc(45vh - 20px)" />
                        }
                        else
                        {
                            @foreach (var t in downloadedTemplates.Where(x => x.CanvasType == CanvasType.Normal))
                            {
                                <MudItem xs="6" Style="padding:4px;">
                                    <MudCard style="padding:16px;background:#E5E5E5;height:220px;position:relative;" class="flex-vertical-center" Elevation="0">
                                        @if (Versions.TryGetValue(t.WMCanvas.ID, out int v) && v > t.WMCanvas.Version)
                                        {
                                            <MudChip Size="Size.Small" Color="Color.Error" Style="position:absolute;top:10px;right:10px" OnClick="()=>DownloadTemplate(t.WMCanvas.ID)">有更新</MudChip>
                                        }
                                        <MudImage Style="height:100%;width:100%;" Src="@t.Src" ObjectFit="ObjectFit.Contain" @onclick="()=>OpenFocus('d',t, true)" />
                                    </MudCard>
                                </MudItem>
                            }
                            @if (downloadedTemplates.Where(x => x.CanvasType == CanvasType.Split).Count() > 0)
                            {
                                <MudItem xs="12" Style="padding:4px;">
                                    <MudText Typo="Typo.h5"><b>拼图</b></MudText>
                                </MudItem>
                            }
                            @foreach (var t in downloadedTemplates.Where(x => x.CanvasType == CanvasType.Split))
                            {
                                <MudItem xs="6" Style="padding:4px;">
                                    <MudCard style="padding:16px;background:#E5E5E5;height:220px;position:relative;" class="flex-vertical-center" Elevation="0">
                                        @if (Versions.TryGetValue(t.WMCanvas.ID, out int v) && v > t.WMCanvas.Version)
                                        {
                                            <MudChip Size="Size.Small" Color="Color.Error" Style="position:absolute;top:10px;right:10px" OnClick="()=>DownloadTemplate(t.WMCanvas.ID)">有更新</MudChip>
                                        }
                                        <MudImage Style="height:100%;width:100%;" Src="@t.Src" ObjectFit="ObjectFit.Contain" @onclick="()=>OpenFocus('d',t, true)" />
                                    </MudCard>
                                </MudItem>
                            }
                        }
                    </MudGrid>
                </MudPaper>
            </MSwiperSlide>
            <SwiperTabItem>
                <MudPaper Elevation="0" Style="padding: 8px 18px;height: 100%;overflow: auto;scrollbar-width: none;">
                    <MudGrid Class="pt-2" Justify="Justify.FlexStart">
                        @foreach (var t in ILikeTemplates)
                        {
                            <MudItem xs="6" Style="padding:4px;">
                                <MudCard style="padding:16px;background:#E5E5E5;height:220px" class="flex-vertical-center" Elevation="0">
                                    @if (!string.IsNullOrEmpty(t.Src))
                                    {
                                        <MudImage Style="height:100%;width:100%;" Src="@t.Src" ObjectFit="ObjectFit.Contain" @onclick="()=>OpenFocus('r',t, true)" />
                                    }
                                </MudCard>
                            </MudItem>
                        }
                    </MudGrid>
                </MudPaper>
            </SwiperTabItem>
        </MSwiper>
    </div>
    <MDialog @bind-Value="FocusImageShow" Fullscreen>
        <TemplateLargeView CloseEvent="()=> FocusImageShow = false"
                           downloadedTemplates="downloadedTemplates"
                           DownloadEvent="DownloadTemplate"
                           FocusImage="FocusImage"
                           FocusImageId="FocusImageId"
                           FocusImageSrc="FocusImageSrc"
                           FocusImageType="FocusImageType"
                           GeneratePhotoEvent="GeneratePhoto"
                           ILikeTemplates="ILikeTemplates"
                           OpenCameraEvent="OpenCamera"
                           subscribed="subscribed"
                           SubscribeEvent="Subscribe"
                           ZipedTemplates="ZipedTemplates" />
    </MDialog>

    <MOverlay Value="loading.Show">
        <MProgressCircular indeterminate
                           Size="64"></MProgressCircular>
    </MOverlay>
    <MOverlay Value="@faildShow" DarkBackground="true" Absolute="true" ZIndex="99999">
        <MudPaper Elevation="0" Class="pa-2" Width="80vw" Style="margin:0 10vw;">
            <MudStack Style="text-align:center;">
                <MudText Typo="Typo.subtitle1" Color="Color.Default"> 失败提示</MudText>
            </MudStack>
            <br />
            <MudText Typo="Typo.subtitle2" Color="Color.Secondary">
                @failedMessage
            </MudText>
            <br />

            <MudText Typo="Typo.subtitle2" Color="Color.Default">
                <strong>如何获取硬币</strong>
            </MudText>
            <MudText Typo="Typo.subtitle2" Color="Color.Default">
                上传模板，用户下载<br />
                开通会员
            </MudText>
            <MudButton Color="Color.Default" Variant="Variant.Filled" DisableElevation FullWidth OnClick="()=>faildShow = false" Size="Size.Small" Class="mt-2">确定</MudButton>
        </MudPaper>
    </MOverlay>
</div>

@code {

    bool loading_down = false;
    StringNumber tab = "我的下载";
    List<string> tab1Head = ["我的下载", "我的收藏"];
    List<WMZipedTemplate> downloadedTemplates = new();
    List<WMZipedTemplate> ILikeTemplates = new();
    Dictionary<string, int> Versions = [];
    bool FocusImageShow = false;
    WMZipedTemplate FocusImage;
    char FocusImageType = ' ';
    List<Tuple<string, List<WMZipedTemplate>>> subscribed = new();
    List<WMZipedTemplate> ZipedTemplates = new();
    WMainLoading loading = new();
    WMTemplateList CurrentImage;
    List<WMTemplateList> Images = new();
    string FocusImageId = "";
    bool faildShow = false;
    string failedMessage = "";
    string FocusImageSrc = "";

    protected override async Task OnInitializedAsync()
    {
        try
        {
            await Global.InitConfig();
            Global.DeviceType = Shared.Enums.DeviceType.Andorid;
            Global.PrimaryKey = ClientInstance.Key();
            await Global.Login();
            await LoadTemplates();
            await LoadCollectTemplate();
            await api.DownloadLogoes();
            await InitVersion(downloadedTemplates.Select(x => x.WMCanvas.ID).ToList());
            await api.PageVisitRecord(ProgramPage.MyTemplate, Platform.Andorid);
        }
        catch (Exception ex)
        {
            //ClientInstance.ShowMsg(Snackbar, ex.Message, Severity.Error);
        }
    }

    protected override Task OnPageDeactivatedAsync()
    {
        return base.OnPageDeactivatedAsync();
    }

    async Task LoadTemplates()
    {
        loading_down = true;
        StateHasChanged();
        var api = new APIHelper();
        if (!Directory.Exists(Global.AppPath.TemplatesFolder))
        {
            Directory.CreateDirectory(Global.AppPath.TemplatesFolder);
        }

        try
        {
            var basePath = Global.AppPath.TemplatesFolder;
            var folder = new DirectoryInfo(basePath);
            foreach (var tFolder in folder.GetDirectories())
            {
                WMZipedTemplate dirct = new();
                dirct.WatermarkId = tFolder.Name;
                var configPath = basePath + dirct.WatermarkId + System.IO.Path.DirectorySeparatorChar + "config.json";
                if (System.IO.File.Exists(configPath))
                {
                    var content = File.ReadAllText(configPath);
                    dirct.WMCanvas = Global.ReadConfig(content);
                    dirct.WMCanvas.Exif[dirct.WMCanvas.ID] = ExifHelper.DefaultMeta;
                    dirct.CanvasType = dirct.WMCanvas.CanvasType;
                    downloadedTemplates.Add(dirct);
                }
            }
            foreach (var tp in downloadedTemplates)
            {
                await Global.InitFonts([tp.WMCanvas]);
                var b64 = await helper.GenerationAsync(tp.WMCanvas, null, true, false);
                tp.Src = await JSRuntime.InvokeAsync<string>("byteToUrl", b64);
            }
            loading_down = false;
            HapticFeedback.Default.Perform(HapticFeedbackType.Click);
            StateHasChanged();
        }
        catch (Exception ex)
        {
            //Watermark.Shared.Models.ClientInstance.ShowMsg(Snackbar, ex.Message, Severity.Error);
            loading_down = false;
        }
    }

    async Task LoadCollectTemplate()
    {
        var api = new APIHelper();
        var getILike = await api.GetILike(Global.CurrentUser?.ID ?? "");
        if (getILike != null && getILike.success && getILike.data != null)
        {
            ILikeTemplates = getILike.data;
            ILikeTemplates.ForEach(x => x.Src = Global.GetSrc(x.WatermarkId));
        }

    }

    async Task InitVersion(List<string> ids)
    {
        var version = await api.GetVersions(ids);
        if (version.success && version.data != null)
        {
            foreach (var e in version.data)
            {
                Versions[e.Key] = e.Value;
            }
        }
    }

    async Task<WMZipedTemplate> LoadSingleTemplates(string watermarkId)
    {
        var api = new APIHelper();
        if (!Directory.Exists(Global.AppPath.TemplatesFolder))
        {
            Directory.CreateDirectory(Global.AppPath.TemplatesFolder);
        }

        try
        {
            WMZipedTemplate dirct = new();
            dirct.WatermarkId = watermarkId;
            var configPath = Global.AppPath.TemplatesFolder + watermarkId + System.IO.Path.DirectorySeparatorChar + "config.json";
            if (!System.IO.File.Exists(configPath)) return dirct;
            var canvas = await Task.Run(() =>
            {
                var content = File.ReadAllText(configPath);
                return Global.ReadConfig(content);
            });
            dirct.WMCanvas = canvas;
            dirct.WMCanvas.Exif[canvas.ID] = ExifHelper.DefaultMeta;
            dirct.CanvasType = dirct.WMCanvas.CanvasType;
            await Global.InitFonts([canvas]);
            var b64 = await helper.GenerationAsync(canvas, null, true, false);
            dirct.Src = await JSRuntime.InvokeAsync<string>("byteToUrl", b64);
            return dirct;
        }
        catch (Exception ex)
        {
           Common.ShowMsg(PopupService, ex.Message, AlertTypes.Error);
           return new WMZipedTemplate();
        }
    }


    async void DownloadTemplate(string watermarkId)
    {
        var action = new Action(async () =>
        {
            var api = new APIHelper();
            if (!Global.CurrentUser.IsVIP)
            {
                var auth = await api.DownloadTemplate(Global.CurrentUser?.ID ?? "", watermarkId);
                if (!auth.success)
                {
                    FocusImageShow = false;
                    faildShow = true;
                    failedMessage = auth.message.content;
                    await PublicMethods.ReLogin();
                    StateHasChanged();
                    return;
                }
            }

            var w = ZipedTemplates.FirstOrDefault(x => x.WatermarkId == watermarkId);
            var r = await api.Download(watermarkId, w?.UserId ?? "");
            if (r)
            {
                HapticFeedback.Default.Perform(HapticFeedbackType.Click);
                FocusImageShow = false;
                Common.ShowMsg(PopupService, "下载完成", AlertTypes.Success);
                var dir = await LoadSingleTemplates(watermarkId);
                if (!downloadedTemplates.Any()) downloadedTemplates.Add(dir);
                else if (!downloadedTemplates.Any(x => x.WatermarkId == dir.WatermarkId)) downloadedTemplates.Insert(0, dir);
                else if (downloadedTemplates.Any(x => x.WatermarkId == dir.WatermarkId))
                {
                    var idx = downloadedTemplates.FindIndex(x => x.WatermarkId == dir.WatermarkId);
                    var item = downloadedTemplates.First(x => x.WatermarkId == dir.WatermarkId);
                    downloadedTemplates.Remove(item);
                    downloadedTemplates.Insert(idx, dir);
                }
                await InitVersion([watermarkId]);
                StateHasChanged();
            }
        });
        if (Global.CurrentUser == null || string.IsNullOrEmpty(Global.CurrentUser.ID))
        {
            FocusImageShow = false;
            //DialogOptions topCenter = new DialogOptions() { NoHeader = true, FullScreen = true };
            //var rst = DialogService.Show<Watermark.Razor.Components.LoginDialog>("", topCenter);
            NavController.Push("/login");
            // var dialogResult = await rst.Result;
            // if (!dialogResult.Canceled && dialogResult.Data.Equals(true))
            // {
            //     FocusImageShow = false;
            //     action.Invoke();
            // }
            // return;
        }
        var p = Global.AppPath.TemplatesFolder + watermarkId;
        if (Directory.Exists(p))
        {
            FocusImageShow = false;
            var confirmed = await PopupService.ConfirmAsync("确认覆盖","此模板已存在，确定覆盖？",AlertTypes.Info);
            if (confirmed == true)
            {
                Directory.Delete(p, true);
                action.Invoke();
            }
        }
        else
        {
            action.Invoke();
        }
    }

    void OpenFocus(char t, WMZipedTemplate zip, bool b)
    {
        HapticFeedback.Default.Perform(HapticFeedbackType.Click);
        FocusImage = zip;
        FocusImageType = t;
        FocusImageId = zip.WatermarkId;
        FocusImageSrc = zip.Src;
        FocusImageShow = b;
        StateHasChanged();
    }

    async Task SelectSplitPhoto(WMZipedTemplate template)
    {
        try
        {
            var result = await FilePicker.PickMultipleAsync(new PickOptions
                {
                    PickerTitle = "长按多选照片",
                    FileTypes = FilePickerFileType.Jpeg
                });

            if (result == null || !result.Any()) return;
            loading.Message = "正在生成图片...";
            loading.Show = true;
            StateHasChanged();
            var cvs = Global.ReadConfig(Global.CanvasSerialize(template.WMCanvas));

            Dictionary<string, Dictionary<string, string>> exif = [];
            exif[cvs.ID] = ExifHelper.DefaultMeta;
            int c = 0;
            foreach (var container in cvs.Children)
            {
                if (c <= result.Count() - 1 && !container.ContainerProperties.FixImage)
                {
                    container.Path = result.Skip(c++).Take(1).First().FullPath;
                    exif[container.ID] = ExifHelper.ReadImage(container.Path);
                }
            }

            CurrentImage = new();
            cvs.Exif = exif;
            CurrentImage.Canvas = cvs;
            CurrentImage.ID = CurrentImage.Canvas.ID;
            var b64 = await helper.GenerationAsync(cvs, null, true, false);
            CurrentImage.Src = await JSRuntime.InvokeAsync<string>("byteToUrl", b64);
            Images = [CurrentImage];
            loading.Show = false;
            //openDrawer = true;
            StateHasChanged();
        }
        catch (Exception ex)
        {
            Common.ShowMsg(PopupService, ex.Message, AlertTypes.Error);
        }
    }

    async Task OpenPhoto(WMZipedTemplate template)
    {
        try
        {
            var result = await FilePicker.PickMultipleAsync(new PickOptions
                {
                    PickerTitle = "长按多选照片",
                    FileTypes = FilePickerFileType.Images
                });
            if (result is null || result.Count() == 0) return;
            Global.VipFuncPermission(() => result.Count() > 3, "超过3张图片");
            loading.Message = "正在生成图片...";
            loading.Show = true;
            StateHasChanged();
            Images = new List<WMTemplateList>();
            if (!Directory.Exists(Global.AppPath.ThumbnailFolder))
            {
                Directory.CreateDirectory(Global.AppPath.ThumbnailFolder);
            }
            foreach (var f in result)
            {
                var img = new WMTemplateList();
                var cvs = Global.ReadConfig(Global.CanvasSerialize(template.WMCanvas));
                cvs.Path = f.FullPath;
                img.Canvas = cvs;
                cvs.Exif[cvs.ID] = await ExifHelper.ReadImageAsync(f.FullPath);
                img.ID = cvs.ID;
                img.Path = f.FullPath;
                Global.CheckImageExtension(f.FullPath);
                var thumbnail = Global.AppPath.ThumbnailFolder + f.FileName;
                await Global.WriteThumbnailImageAsync(f.FullPath, thumbnail);
                Images.Add(img);
            }
            CurrentImage = Images.First();
            var b64 = await helper.GenerationAsync(CurrentImage.Canvas, null, true, false);
            CurrentImage.Src = await JSRuntime.InvokeAsync<string>("byteToUrl", b64);
            loading.Show = false;
            //openDrawer = true;
            StateHasChanged();
        }
        catch (Exception ex)
        {
            Common.ShowMsg(PopupService, ex.Message, AlertTypes.Error);
        }
    }


    async void GeneratePhoto(WMZipedTemplate template)
    {
        HapticFeedback.Default.Perform(HapticFeedbackType.Click);
        FocusImageShow = false;
        if (template.CanvasType == CanvasType.Normal) await OpenPhoto(template);
        else await SelectSplitPhoto(template);
    }

    async void OpenCamera(WMZipedTemplate template)
    {
        HapticFeedback.Default.Perform(HapticFeedbackType.Click);
        var result = await MediaPicker.Default.CapturePhotoAsync(new MediaPickerOptions
            {
                Title = "拍照"
            });

        if (result is null) return;
        FocusImageShow = false;
        if (template.CanvasType == CanvasType.Normal)
        {
            loading.Message = "正在生成图片...";
            loading.Show = true;
            StateHasChanged();
            Images = new List<WMTemplateList>();
            if (!Directory.Exists(Global.AppPath.ThumbnailFolder))
            {
                Directory.CreateDirectory(Global.AppPath.ThumbnailFolder);
            }
            var fullpath = result.FullPath;
            var img = new WMTemplateList();
            var cvs = Global.ReadConfig(Global.CanvasSerialize(template.WMCanvas));
            cvs.Path = fullpath;
            img.Canvas = cvs;
            cvs.Exif[cvs.ID] = await ExifHelper.ReadImageAsync(fullpath);
            img.ID = cvs.ID;
            img.Path = fullpath;
            Global.CheckImageExtension(fullpath);
            var thumbnail = Global.AppPath.ThumbnailFolder + Path.GetFileName(fullpath);
            await Global.WriteThumbnailImageAsync(fullpath, thumbnail);
            Images.Add(img);

            CurrentImage = Images.First();
            var b64 = await helper.GenerationAsync(CurrentImage.Canvas, null, true, false);
            CurrentImage.Src = await JSRuntime.InvokeAsync<string>("byteToUrl", b64);
            loading.Show = false;
            //openDrawer = true;
            StateHasChanged();
        }
        else
        {
            loading.Message = "正在生成图片...";
            loading.Show = true;
            StateHasChanged();
            var cvs = Global.ReadConfig(Global.CanvasSerialize(template.WMCanvas));
            foreach (var container in cvs.Children)
            {
                if (!container.ContainerProperties.FixImage)
                {
                    container.Path = result.FullPath;
                    cvs.Exif[container.ID] = ExifHelper.ReadImage(container.Path);
                }
            }

            CurrentImage = new();
            CurrentImage.Canvas = cvs;
            CurrentImage.ID = CurrentImage.Canvas.ID;
            var b64 = await helper.GenerationAsync(cvs, null, true, false);
            CurrentImage.Src = await JSRuntime.InvokeAsync<string>("byteToUrl", b64);
            Images = [CurrentImage];
            loading.Show = false;
            //openDrawer = true;
            StateHasChanged();
        }

    }

    async void Subscribe(string userId)
    {
        // if (Global.CurrentUser == null || string.IsNullOrEmpty(Global.CurrentUser.ID)) return;
        // var helper = new APIHelper();
        // var r = await helper.SubscribeUser(Global.CurrentUser.ID, userId);
        // await LoadTemplatesMarket();
    }


}