@page "/appsetting"
@using Masa.Blazor.Presets
@using Watermark.Win.Models
@using Masa.Blazor
@using MudBlazor
@using Icons = MudBlazor.Icons
@inject IPopupService PopupService
@inherits PStackPageBase

<PStackPageBarInit Title="设置" Dense Flat CenterTitle>
</PStackPageBarInit>

<MudForm Style="text-align:center">
    <MudPaper Style="@cardStyle" Elevation="0" class="pa-3">
        <MudStack Row Justify="Justify.SpaceBetween" Style="align-items: center;" @onclick="DeleteAccount">
            <MudText Typo="Typo.button"> 注销账号 </MudText>
            <MudIcon Icon="@Icons.Material.Filled.Delete" Size="Size.Small" />
        </MudStack>
    </MudPaper>
    <MudPaper Style="@cardStyle" Elevation="0" class="pa-3">
        <MudStack Row Justify="Justify.SpaceBetween" Style="align-items: center;">
            <MudText Typo="Typo.button"> 增强EXIF解析 </MudText>
            <MudSwitch @bind-Value="@Global.SECOND_EXIF" Color="Color.Primary" Size="Size.Small" />
        </MudStack>
    </MudPaper>
    <MudPaper Style="@cardStyle" Elevation="0" class="pa-3">
        <MudStack Row Justify="Justify.SpaceBetween" style="align-items: center" @onclick="()=> DeleteCache(Global.AppPath.TemplatesFolder)">
            <MudText Typo="Typo.button">下载缓存</MudText>
            <MudIcon Icon="@Icons.Material.Filled.Delete" Size="Size.Small" />
        </MudStack>

        <MudDivider Class="my-2" />
        <MudStack Row Justify="Justify.SpaceBetween" style="align-items: center" @onclick="()=> DeleteCache(Global.AppPath.LogoesFolder)">
            <MudText Typo="Typo.button">图标缓存</MudText>
            <MudIcon Icon="@Icons.Material.Filled.Delete" Size="Size.Small" />
        </MudStack>
    </MudPaper>

</MudForm>




@code {
    [Parameter]
    public EventCallback<bool> CloseEvent { get; set; }
    string UserName { get; set; }
    string Password { get; set; }
    bool Loading = false;

    string cardStyle => $"margin:20px 16px;background:{Colors.Grey.Lighten4}";



    public async void LoginOK()
    {
        Loading = true;
        APIHelper helper = new APIHelper();
        var result = await helper.LoginIn(UserName, Password);
        string message = "";
        AlertTypes severity = AlertTypes.Success;
        if (result.success)
        {
            Global.CurrentUser = Global.SetUserInfo(result.data.data);
            message = "登录成功";
            severity = AlertTypes.Success;
            await Global.WriteAccount2LocalAsync(UserName, helper.GetMD5(Password));
            if (CloseEvent.HasDelegate) await CloseEvent.InvokeAsync(true);
            StateHasChanged();
        }
        else
        {
            severity = AlertTypes.Error;
            message = result.message?.content ?? result.data.Message;
        }

        Common.ShowMsg(PopupService, message, severity);
        Loading = false;
        StateHasChanged();
    }

    void DeleteCache(string p)
    {
        if (Directory.Exists(p))
        {
            Directory.Delete(p, true);
            Common.ShowMsg(PopupService, "清除完成", AlertTypes.Success);
        }
    }

    void DeleteAccount()
    {

    }
}
