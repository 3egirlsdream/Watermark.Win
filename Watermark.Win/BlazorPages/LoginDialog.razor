@using Watermark.Win.Models
@inject ISnackbar Snackbar

<MudDialog Style="width:400px;background:#F9FAFC">
    <DialogContent>
        <MudForm>
            <MudTextField @bind-Value="UserName" T="string" Label="邮箱" Required="true" RequiredError="邮箱不能为空" AutoFocus />
            <MudTextField @bind-Value="Password" T="string" Label="密码" Required="true" RequiredError="密码不能为空" Class="mt-5" InputType="InputType.Password" />
        </MudForm>
        <MudOverlay Visible="@Loading" DarkBackground="true" Absolute="false" ZIndex="999">
            <MudProgressCircular Color="Color.Secondary" Indeterminate="true" />
        </MudOverlay>

    </DialogContent>
    <DialogActions>
        <MudButton Variant="Variant.Text" OnClick="OpenForgotSignUpDialog" Size="Size.Small" Color="Color.Default" Style="position: absolute;left: 20px;">忘记密码</MudButton>
        <MudStack Row="true" Justify="Justify.SpaceBetween">
            <MudButton Variant="Variant.Filled" OnClick="LoginOK" Size="Size.Small" Color="Color.Primary">登录</MudButton>
            <MudButton Variant="Variant.Filled" Color="Color.Default" OnClick="OpenSignUpDialog" Size="Size.Small">注册</MudButton>
        </MudStack>
    </DialogActions>
</MudDialog>




@code {

    [Inject]
    private IDialogService DialogService { get; set; }
    [CascadingParameter]
    MudDialogInstance MudDialog { get; set; }

    string UserName { get; set; }
    string Password { get; set; }
    bool Loading = false;




    public async void LoginOK()
    {
        Loading = true;
        APIHelper helper = new APIHelper();
        var result = await helper.LoginIn(UserName, Password);
        string message = "";
        Severity severity = Severity.Success;
        Snackbar.Clear();
        Snackbar.Configuration.PositionClass = Defaults.Classes.Position.TopCenter;

        if (result.success)
        {
            Global.CurrentUser = Global.SetUserInfo(result.data.data);
            message = "登录成功";
            severity = Severity.Success;
            await Global.WriteAccount2LocalAsync(UserName, helper.GetMD5(Password));
            MudDialog.Close(true);
            StateHasChanged();
        }
        else
        {
            severity = Severity.Error;
            message = result.message?.content ?? result.data.Message;
        }

        Snackbar.Add(message, severity, config =>
        {
            config.ShowCloseIcon = false;
        });
        Loading = false;
        StateHasChanged();
    }

    async void OpenSignUpDialog()
    {
        var param = new DialogParameters<SignUpDialog>();
        param.Add(x => x.FuncType, 0);
        var rst = DialogService.Show<SignUpDialog>("", param);
        var dialogResult = await rst.Result;
        if (!dialogResult.Canceled && dialogResult.Data.Equals(true))
        {
            StateHasChanged();
            MudDialog.Close(true);
        }
    }

    async void OpenForgotSignUpDialog()
    {
        var param = new DialogParameters<SignUpDialog>();
        param.Add(x => x.FuncType, 1);
        var rst = DialogService.Show<SignUpDialog>("", param);
        var dialogResult = await rst.Result;
        if (!dialogResult.Canceled && dialogResult.Data.Equals(true))
        {
            StateHasChanged();
            MudDialog.Close(true);
        }
    }
}
