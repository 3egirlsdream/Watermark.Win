@using System.IO
@using System.Diagnostics
@using System.Collections.Concurrent
@using Masa.Blazor
@using Microsoft.AspNetCore.Components.Forms
@using Microsoft.JSInterop
@using Watermark.Razor
@using Watermark.Razor.Components
@using Watermark.Razor.Parts
@using Watermark.Win.BlazorPages
@using Watermark.Win.Models
@using Watermark.Win.Views
@inject IPopupService PopupService
@inject IJSRuntime JSRuntime
@inject IWMWatermarkHelper helper

<style>
    .d-mw300 {
        min-width: 300px;
    }

    .m-treeview-node__level {
        width: 0px;
    }

    .hover {
    }

        .hover:hover {
            cursor: pointer;
        }

    .exif-selector {
    }

        .exif-selector .m-input__control {
            display: none;
        }

        .exif-selector .m-input__prepend-outer {
            margin: 0px;
        }

        .exif-selector .mdi-paperclip::before {
            font-size: 20px;
        }
</style>
<MApp Style="background:#F9FAFC;height:100vh;width:100vw;overflow-x:hidden">
    <MErrorHandler>
        <Masa.Blazor.MCard Color="grey lighten-4" Flat Tile Style="height:100%">
            <Masa.Blazor.MToolbar Outlined Dense Elevation="0">
                <Masa.Blazor.MMenu OffsetY>
                    <ActivatorContent>
                        <Masa.Blazor.MButton Color="primary" @attributes="@context.Attrs" Elevation="0" Plain>文件</Masa.Blazor.MButton>
                    </ActivatorContent>
                    <ChildContent>
                        <Masa.Blazor.MList>
                            <Masa.Blazor.MListItem OnClick="ImportLocalImages" Title="导入图片" PrependIcon="@ICONS.AddImage" />
                            <Masa.Blazor.MListItem OnClick="() => showLogoStore = true" Title="图标库" PrependIcon="@ICONS.ImageStore" />
                            <Masa.Blazor.MListItem OnClick="()=>showExport = true" Title="导出" PrependIcon="@ICONS.Export" />
                            <Masa.Blazor.MDivider />
                            <Masa.Blazor.MListItem OnClick="()=> System.Windows.Application.Current.Shutdown()" Title="退出" PrependIcon="@ICONS.Exit" />
                        </Masa.Blazor.MList>
                    </ChildContent>
                </Masa.Blazor.MMenu>
                <Masa.Blazor.MMenu OffsetY>
                    <ActivatorContent>
                        <Masa.Blazor.MButton Color="primary" @attributes="@context.Attrs" Elevation="0" Plain>模板</Masa.Blazor.MButton>
                    </ActivatorContent>
                    <ChildContent>
                        <Masa.Blazor.MList>
                            <Masa.Blazor.MListItem OnClick="() => openMyTemplate = true" Title="我的模板" PrependIcon="@ICONS.Star" />
                            <Masa.Blazor.MListItem OnClick="() => openCreateNew = true" Title="创建模板" PrependIcon="@ICONS.Pencil" />
                            <Masa.Blazor.MListItem OnClick="() => openMarket = true" Title="模板市场" PrependIcon="@ICONS.Market" />
                        </Masa.Blazor.MList>
                    </ChildContent>
                </Masa.Blazor.MMenu>
                <Masa.Blazor.MMenu OffsetY>
                    <ActivatorContent>
                        <Masa.Blazor.MButton Color="primary" @attributes="@context.Attrs" Elevation="0" Plain>关于</Masa.Blazor.MButton>
                    </ActivatorContent>
                    <ChildContent>
                        <Masa.Blazor.MList>
                            <Masa.Blazor.MListItem OnClick="ClientInstance.OpenSetting" Title="设置" PrependIcon="@ICONS.Setting" />
                            <Masa.Blazor.MListItem OnClick="() => showSignUp = true" Title="注册账号" PrependIcon="@ICONS.AccountAdd" />
                        </Masa.Blazor.MList>
                    </ChildContent>
                </Masa.Blazor.MMenu>
                <Masa.Blazor.MMenu OffsetY>
                    <ActivatorContent>
                        <Masa.Blazor.MButton Color="primary" @attributes="@context.Attrs" Elevation="0" Plain>交流群</Masa.Blazor.MButton>
                    </ActivatorContent>
                    <ChildContent>
                        <Masa.Blazor.MList>
                            <Masa.Blazor.MListItem Title="交流群1：866034817 (已满)" PrependIcon="@ICONS.QQ" />
                            <Masa.Blazor.MListItem Title="交流群2：836325187" PrependIcon="@ICONS.QQ" />
                        </Masa.Blazor.MList>
                    </ChildContent>
                </Masa.Blazor.MMenu>
                <Masa.Blazor.MMenu OffsetY>
                    <ActivatorContent>
                        <Masa.Blazor.MButton Color="primary" @attributes="@context.Attrs" Elevation="0" Plain>更多</Masa.Blazor.MButton>
                    </ActivatorContent>
                    <ChildContent>
                        <Masa.Blazor.MList>
                            <Masa.Blazor.MListItem Title="网页版" OnClick="@(()=>OpenLink("http://www.thankful.top"))" PrependIcon="@ICONS.Web" />
                            <Masa.Blazor.MListItem Title="点个赞" OnClick="@(()=>OpenLink("https://github.com/3egirlsdream/Watermark.Win"))" PrependIcon="@ICONS.Star" />
                            <Masa.Blazor.MListItem Title="提交反馈" OnClick="@(()=>OpenLink("https://github.com/3egirlsdream/Watermark.Win/issues"))" PrependIcon="@ICONS.Feedback" />
                            <Masa.Blazor.MListItem Title="赞助" OnClick="@(()=>OpenCommonDialog("http://cdn.thankful.top/wx.jpg"))" PrependIcon="@ICONS.Wechat" />
                            <Masa.Blazor.MListItem Title="安卓版" OnClick="@(()=>OpenCommonDialog("https://cdn.thankful.top/andorid.png"))" PrependIcon="@ICONS.Android" />
                        </Masa.Blazor.MList>
                    </ChildContent>
                </Masa.Blazor.MMenu>
                @if (Global.CurrentUser != null && Global.CurrentUser.USER_NAME == "cxk")
                {
                    <Masa.Blazor.MMenu OffsetY>
                        <ActivatorContent>
                            <Masa.Blazor.MButton Color="primary" @attributes="@context.Attrs" Elevation="0" Plain>七牛</Masa.Blazor.MButton>
                        </ActivatorContent>
                        <ChildContent>
                            <Masa.Blazor.MList>
                                <Masa.Blazor.MListItem Title="文件管理" OnClick="()=>DialogService.Show<QiniuManagementDialog>(string.Empty)" />
                            </Masa.Blazor.MList>
                        </ChildContent>
                    </Masa.Blazor.MMenu>
                }
                <MSpacer />
                <ColorPicker2 />
                <MMenu OffsetX CloseOnContentClick="false">
                    <ActivatorContent>
                        <div @attributes="@context.Attrs" style="display:flex;align-content:flex-start;align-items:center">
                            <MIcon Color="Color.Inherit" Style="cursor:pointer" @onclick="()=> ShowUserInfo = !ShowUserInfo">@ICONS.Account</MIcon>
                            @if (Global.CurrentUser != null && !string.IsNullOrEmpty(Global.CurrentUser.DISPLAY_NAME))
                            {
                                <Label Name="@Global.CurrentUser.DISPLAY_NAME" Class="ml-1" />
                            }
                        </div>
                    </ActivatorContent>

                    <ChildContent>
                        <MCard>
                            @if (Global.CurrentUser != null && !string.IsNullOrEmpty(Global.CurrentUser.ID))
                            {
                                <MList>
                                    <MListItem>
                                        <MListItemAvatar>
                                            @if (!string.IsNullOrEmpty(Global.CurrentUser.IMG))
                                            {
                                                <MImage Width="50" Height="50" Src="@Global.CurrentUser.IMG" Contain />
                                            }
                                            else
                                            {
                                                <img src="https://cdn.masastack.com/stack/images/website/masa-blazor/jack.png" alt="MASA">
                                            }
                                        </MListItemAvatar>

                                        <MListItemContent>
                                            <MListItemTitle>@Global.CurrentUser.DISPLAY_NAME</MListItemTitle>
                                            <MListItemSubtitle>@Global.CurrentUser.USER_NAME</MListItemSubtitle>
                                        </MListItemContent>

                                        <MListItemAction>
                                            @if (Global.CurrentUser.IsVIP)
                                            {
                                                <Watermark.Razor.Parts.IconVip />
                                            }
                                            else
                                            {
                                                <Watermark.Razor.Parts.IconVipExpired />
                                            }
                                        </MListItemAction>
                                    </MListItem>
                                </MList>
                                <MDivider />

                                <Label Class="px-4 my-1" Name="🤩🤗🥵" Small="false"></Label>

                                <div style="display:flex;align-items:center;" class="px-4 py-1">
                                    <Label Name="硬币：" Small="false" />
                                    <Watermark.Razor.Parts.IconCoin />
                                    <Label Name="@Global.CurrentUser.COINS.ToString()" Small="false" />
                                </div>

                                <Label Class="px-4 py-1" Name="@(Global.CurrentUser.IsVIP ? "会员到期时间：" + Global.CurrentUser.EXPIRE_DATE : "会员已过期")" />
                                <MCardActions>
                                    <MSpacer></MSpacer>
                                    <MButton Plain Style="margin-left:200px;" OnClick="()=> { Global.CurrentUser = new WMLoginChildModel(); }">退出</MButton>
                                </MCardActions>
                            }
                            else
                            {
                                <MSkeletonLoader Class="mx-auto"
                                                 MaxWidth="300"
                                                 Type="article">
                                </MSkeletonLoader>
                                <MCardActions>
                                    <MSpacer />
                                    <MButton Plain Color="Color.Primary" OnClick="() => showLogin = true">登录</MButton>
                                    <MButton Plain OnClick="() => showSignUp = true">注册</MButton>
                                </MCardActions>
                            }

                        </MCard>
                    </ChildContent>
                </MMenu>
            </Masa.Blazor.MToolbar>
            <div style="height:calc(100% - 48px);width:100%;display:flex;justify-content:flex-start">
                <div style="width:300px;height:100%;overflow-y:hidden;">
                    <MTabs @bind-Value="tab" FixedTabs Height="30">
                        <MTab Value="@("模板")">
                            模板
                        </MTab>
                        <MTab Value="@("拼图")">
                            拼图
                        </MTab>
                    </MTabs>
                    <MTabsItems Value="@tab" Style="height:calc(100% - 30px); overflow-y:overlay">
                        <MTabItem Value="@("模板")">
                            <MTreeview Items="wMTemplates.Where(x => x.Canvas.CanvasType == Shared.Enums.CanvasType.Normal).OrderBy(x => x.Canvas.Name).ToList()"
                                       Activatable
                                       ItemKey="u => u.ID"
                                       ItemText="u => null"
                                       ItemChildren="u => []"
                                       OpenOnClick>
                                <PrependContent>
                                    @if (context.Item != null)
                                    {
                                        <div @onclick="() => ChangeTemplate(context.Item)" style="display:flex;align-items:center;justify-content:space-between">
                                            <MImage Width="40" Height="40" Contain Src="@context.Item.Src" />
                                            <Watermark.Razor.Parts.Label Name="@context.Item.Canvas.Name" Small="false" Class="ml-1" />
                                        </div>

                                    }
                                </PrependContent>
                            </MTreeview>
                        </MTabItem>
                        <MTabItem Value="@("拼图")">
                            <MTreeview Items="wMTemplates.Where(x => x.Canvas.CanvasType == Shared.Enums.CanvasType.Split).OrderBy(x => x.Canvas.Name).ToList()"
                                       Activatable
                                       ItemKey="u => u.ID"
                                       ItemText="u => null"
                                       ItemChildren="u => []"
                                       OpenOnClick>
                                <PrependContent>
                                    @if (context.Item != null)
                                    {
                                        <div @onclick="() => SelectSplitImages(context.Item)">
                                            <MImage Style="width:300px;padding:4px 0" Contain Src="@context.Item.Src" />
                                        </div>
                                    }
                                </PrependContent>
                            </MTreeview>
                        </MTabItem>
                    </MTabsItems>
                </div>
                <div style="height:100%;width:calc(100% - 600px)">
                    <MSplitter Row Style="height: 100%" BarSize="4">
                        <ChildContent>
                            <MSplitterPane Class="grey lighten-2 d-flex align-center justify-center" Size="70" Style="position:relative">
                                @if (CurrentImage != null && !string.IsNullOrEmpty(CurrentImage.Src))
                                {
                                    <MCard Style="width:50%;height:30px;position:absolute;top:10px;justify-content:flex-start;display:flex;gap:0 4px;align-items:center">
                                        <MCard Style="width:23px;height:23px;cursor:pointer;" @onclick="OpenFullExifInfo">
                                            <Watermark.Razor.Parts.IconExif />
                                        </MCard>
                                        <MCard Width="23" Height="23">
                                            <MFileInput TValue="IBrowserFile"
                                                        Class="exif-selector"
                                                        OnChange="SelectSourceImageExif"
                                                        Style="width: 22px !important; padding: 0px !important; margin:0px"
                                                        HideDetails="true"
                                                        Label="File input"></MFileInput>
                                        </MCard>

                                    </MCard>
                                    <MImage Src="@CurrentImage.Src" Style="width:90%; height:calc(100% - 200px); margin-left:5%;margin-right:5%;" Contain />
                                    @if (SrcLoading)
                                    {
                                        <MProgressCircular Indeterminate="true" Style="position:absolute;top:10px;right:10px" Color="primary" />
                                    }

                                }
                                else
                                {
                                    <Watermark.Razor.Parts.IconImage />
                                }
                            </MSplitterPane>
                            <MSplitterPane Style="min-height:100px;" Size="30">
                                <div style="display:flex;justify-content:flex-start;height:100%;overflow-y:auto;flex-wrap:wrap;">
                                    @foreach (var file in Images)
                                    {
                                        <MCard Elevation="0" Height="190" Width="190" Class="ma-1 hover pa-1">
                                            <MImage Src="@file.Src" Width="@("100%")" Height="@("100%")" Contain Style="cursor: pointer;" @onclick="(()=>ClickImage(file))" />
                                        </MCard>
                                    }
                                </div>
                            </MSplitterPane>
                        </ChildContent>
                        <BarContent>
                            <MIcon Small>mdi-drag-horizontal</MIcon>
                        </BarContent>
                    </MSplitter>
                </div>
                @if (CurrentImage != null && CurrentImage.Canvas != null && showConfig)
                {
                    <Watermark.Razor.Components.DesignConfiguration Style="width:300px;height:100%" canvas="@CurrentImage.Canvas" />
                }

            </div>
        </Masa.Blazor.MCard>

        <MOverlay Dark="false" @bind-Value="WMMainLoading.Show" Absolute="true" ZIndex="99999">
            <MCard Style="width:520px;height:80px; padding:25px 40px 10px 40px;display:flex;align-items:center;justify-content:center;flex-direction:column">
                <MProgressLinear Value="@WMMainLoading.Value" Rounded Striped Height="10" Color="light-blue" Class="my-1" />
                <Watermark.Razor.Parts.Label Name="@WMMainLoading.Message" Small="false" />
            </MCard>
        </MOverlay>
        @if (openMyTemplate)
        {
            <Watermark.Razor.Components.MyTemplates @bind-Visible="openMyTemplate" EditTemplateEvt="OpenDesignAction" />
        }

        <MDialog @bind-Value="openMarket" ContentStyle="height: 90%;overflow:hidden;scrollbar-width: none;border: 15px solid #fff;">
            @if (openMarket)
            {
                <TemplatesMarket ClipboardAction="ClipboardAction" />
            }
        </MDialog>

        <MDialog @bind-Value="@CommonDialog.Show" Width="300">
            <MImage Height="300" Width="300" Contain Src="@CommonDialog.Message" />
        </MDialog>
        <MDialog ContentStyle="width:350px;padding:10px;" @bind-Value="showLogin">
            @if (showLogin)
            {
                <LoginContent CloseEvent="() => showLogin = false" />
            }
        </MDialog>
        <MDialog ContentStyle="width:350px;padding:10px;" @bind-Value="showSignUp">
            @if (showSignUp)
            {
                <SignUpContent CloseEvent="() => showSignUp = false" />
            }
        </MDialog>

        <MDialog @bind-Value="openCreateNew" Width="300" ContentStyle="padding:4px;">
            @if (openCreateNew)
            {
                <NewTemplateDialog ID="@(Guid.NewGuid().ToString("N").ToUpper())" Ok="OpenDesignAction" SelectDefaultImageAction="CreateNewTemplate" OnClose="() => openCreateNew = false" />
            }
        </MDialog>

        <MDialog @bind-Value="showExport" ContentStyle="height: 90%;overflow:hidden;scrollbar-width: none;border: 15px solid #fff;">
            @if (showExport)
            {
                <ExportDialog OnClose="(images) => {Export(images.Where(x => x.IsChecked).ToList()); }" Images="Images" OpenFolderAction="OpenFolderAction" />
            }
        </MDialog>
        <MDialog @bind-Value="showLogoStore" ContentStyle="height: 90%;overflow:hidden;scrollbar-width: none;border: 15px solid #fff;">
            @if (showLogoStore)
            {
                <LogoDialogContent />
            }
        </MDialog>
    </MErrorHandler>
</MApp>


@code {
    [Inject]
    private IDialogService DialogService { get; set; }
    bool openCreateNew = false;
    WMainLoading CommonDialog = new();
    StringNumber tab;
    bool showLogoStore = false;
    bool showExport = false;
    bool openMarket = false;
    bool openMyTemplate = false;
    bool SrcLoading = false;
    bool ShowUserInfo = false;
    bool _expanded = false;
    bool showLogin = false;
    bool showSignUp = false;
    bool showConfig = false;
    List<WMTemplateList> wMTemplates = [];
    WMTemplateList CurrentTemplate;
    WMTemplateList CurrentImage;
    Dictionary<string, Dictionary<string, string>> LogoCacheDic = new();
    ConcurrentDictionary<string, string> LogoBase64 = new ConcurrentDictionary<string, string>();
    List<string> LogoStore = new List<string>();
    List<WMTemplateList> Images = new List<WMTemplateList>();
    protected override async Task OnInitializedAsync()
    {
        try
        {
            APIHelper helper = new APIHelper();
            await Global.InitConfig();
            await InitTemplates();
            await InitLogoStore();
            await Global.Login();
            await helper.DownloadLogoes();
            Global.PrimaryKey = ClientInstance.Key();
        }
        catch (Exception ex)
        {
            Common.ShowMsg(PopupService, ex.Message, AlertTypes.Error);
        }
    }

    public async void OpenMyTemplates()
    {
        Action<WMCanvas> OpenDesigner = new Action<WMCanvas>((x) =>
        {
            OpenDesignAction(x);
        });
        var parameters = new DialogParameters<Watermark.Razor.Components.MyTemplates>();
        parameters.Add(x => x.EditTemplateEvt, OpenDesigner);
        var option = new DialogOptions() { NoHeader = true, MaxWidth = MaxWidth.ExtraLarge };
        var rst = DialogService.Show<Watermark.Razor.Components.MyTemplates>("我的模板", parameters, option);
        var dialog = await rst.Result;
        await InitTemplates();

    }


    public void OpenDesignAction(WMCanvas x)
    {
        var action = new Action(() =>
        {
            var win = new Watermark.Win.Views.DesignWin(x, "");
            win.WindowStartupLocation = System.Windows.WindowStartupLocation.CenterScreen;
            win.ShowDialog();
        });
        OpenWinHelper.Open(action);
    }


    void ImportLocalImages()
    {
        var action = new Action(async () =>
        {
            // 实例化一个文件选择对象
            Microsoft.Win32.OpenFileDialog dialog = new()
                {
                    DefaultExt = ".png",  // 设置默认类型
                    Multiselect = true,                             // 设置可选格式
                    Filter = @"图像文件(*.jpg,*.png)|*jpeg;*.jpg;*.png|JPEG(*.jpeg, *.jpg)|*.jpeg;*.jpg|PNG(*.png)|*.png"
                };
            // 打开选择框选择
            Nullable<bool> result = dialog.ShowDialog();
            if (result == true)
            {
                WMMainLoading.Show = true;
                Images = new List<WMTemplateList>();
                WMMainLoading.Message = $"正在导入图片，一共{dialog.FileNames.Length}, 当前第1个...";
                WMMainLoading.Value = 0;
                StateHasChanged();
                if (!Directory.Exists(Global.AppPath.ThumbnailFolder))
                {
                    Directory.CreateDirectory(Global.AppPath.ThumbnailFolder);
                }
                foreach (var file in dialog.FileNames)
                {
                    WMCanvas canvas = new WMCanvas();
                    canvas.Path = file;
                    canvas.Exif[canvas.ID] = await ExifHelper.ReadImageAsync(file);
                    await Task.Run(() =>
                    {
                        var thumbnail = Global.AppPath.ThumbnailFolder + file.Substring(file.LastIndexOf('\\') + 1);
                        Global.WriteThumbnailImage(file, thumbnail);
                    });
                    var b64 = await Global.GetBase64(file);
                    Images.Add(new WMTemplateList
                        {
                            Canvas = canvas,
                            Src = await JSRuntime.InvokeAsync<string>("byteToUrl", b64),
                            ID = canvas.ID,
                            Path = file
                        });
                    var idx = dialog.FileNames.ToList().IndexOf(file) + 1;
                    WMMainLoading.Message = $"正在导入图片，一共{dialog.FileNames.Length}, 当前第{idx}个...";
                    WMMainLoading.Value = idx * 100.0 / dialog.FileNames.Length;
                    StateHasChanged();
                }


                WMMainLoading.Message = $"导入完成";
                WMMainLoading.Value = 100;
                await Task.Delay(200);
                WMMainLoading.Show = false;
                StateHasChanged();
            }
        });
        OpenWinHelper.Open(action);
    }

    async void ClickImage(WMTemplateList image)
    {
        CurrentImage = image;
        SrcLoading = true;
        CurrentImage.Canvas.Path = CurrentImage.Path;
        var b64 = await helper.GenerationAsync(CurrentImage.Canvas, null, true);
        var src = await JSRuntime.InvokeAsync<string>("byteToUrl", b64);
        CurrentImage.Src = src;
        SrcLoading = false;
        StateHasChanged();
    }

    async void RefreshImage()
    {
        SrcLoading = true;
        CurrentImage.Canvas.Path = CurrentImage.Path;
        var b64 = await helper.GenerationAsync(CurrentImage.Canvas, null, true);
        var src = await JSRuntime.InvokeAsync<string>("byteToUrl", b64);
        CurrentImage.Src = src;
        SrcLoading = false;
        StateHasChanged();
    }


    async Task InitTemplates()
    {
        WMMainLoading.Show = true;
        if (!System.IO.Directory.Exists(Global.AppPath.TemplatesFolder))
        {
            System.IO.Directory.CreateDirectory(Global.AppPath.TemplatesFolder);
        }
        try
        {
            System.IO.DirectoryInfo directoryInfo = new System.IO.DirectoryInfo(Global.AppPath.TemplatesFolder);
            if (wMTemplates != null && wMTemplates.Count > 0)
            {
                foreach (var w in wMTemplates)
                    await JSRuntime.InvokeVoidAsync("revokeUrl", w.Src);
            }
            wMTemplates = new List<WMTemplateList>();
            var directories = directoryInfo.GetDirectories();
            WMMainLoading.Message = $"正在初始化模板，共{directories.Length}个，当前第1个...";
            WMMainLoading.Value = 0;
            int cot = 1;
            foreach (var dirct in directories)
            {
                try
                {
                    var configPath = dirct.FullName + System.IO.Path.DirectorySeparatorChar + "config.json";
                    if (System.IO.File.Exists(configPath))
                    {
                        var content = File.ReadAllText(configPath);
                        var canvas = Global.ReadConfig(content);
                        canvas.Exif[canvas.ID] = ExifHelper.DefaultMeta;
                        await InitFonts([canvas]);
                        var b64 = await helper.GenerationAsync(canvas, null, true);
                        var src = await JSRuntime.InvokeAsync<string>("byteToUrl", b64);
                        var wh = new WMTemplateList
                            {
                                ID = canvas.ID,
                                Canvas = canvas,
                                Src = src
                            };
                        wMTemplates.Add(wh);
                        var idx = directories.ToList().IndexOf(dirct) + 1;
                        WMMainLoading.Value = cot * 100.0 / directories.Length;
                        WMMainLoading.Message = $"正在初始化模板，共{directories.Length}个，当前第{cot++}个...";
                        StateHasChanged();

                    }
                }
                catch (Exception ex)
                {
                    Common.ShowMsg(PopupService, ex.Message, AlertTypes.Error);
                }
            }
            WMMainLoading.Message = $"处理完成...";
            WMMainLoading.Value = 100;
            await Task.Delay(200);
            WMMainLoading.Show = false;
            StateHasChanged();
        }
        catch (Exception ex)
        {
            Common.ShowMsg(PopupService, ex.Message, AlertTypes.Error);
            WMMainLoading.Show = false;
            StateHasChanged();
        }
        finally
        {
            GC.Collect();
        }
    }

    async void ChangeTemplate(WMTemplateList template)
    {
        showConfig = false;
        CurrentTemplate = template;
        if (CurrentImage == null) return;
        SrcLoading = true;
        var b64 = await Task.Run(() =>
        {
            var cvs = Global.ReadConfig(Global.CanvasSerialize(template.Canvas));
            cvs.Exif = CurrentImage.Canvas.Exif;
            CurrentImage.Canvas = cvs;
            cvs.Path = CurrentImage.Path;
            return helper.Generation(cvs, null, true);
        });

        var src = await JSRuntime.InvokeAsync<string>("byteToUrl", b64);
        CurrentImage.Src = src;
        await InitLogoCacheDic(CurrentImage.ID, template);
        SrcLoading = false;
        showConfig = true;
        EnableAll();
        StateHasChanged();
    }

    async void Export(List<WMTemplateList> images)
    {
        showExport = false;
        WMMainLoading.Show = true;
        WMMainLoading.Message = $"正在导出图片，一共{images.Count}张，目前第1张";
        WMMainLoading.Value = 0;
        StateHasChanged();
        var idx = 1;
        var option = new ParallelOptions();
        option.MaxDegreeOfParallelism = Global.MAX_THREAD;
        await Task.Run(() =>
        {
            Parallel.ForEach(images, option, (item) =>
            {
                helper.Generation(item.Canvas, null, false);
                WMMainLoading.Message = $"正在导出图片，一共{images.Count}张，目前第{idx}张";
                WMMainLoading.Value = idx++ * 100.0 / images.Count;
                InvokeAsync(StateHasChanged);
            });
        });

        WMMainLoading.Value = 100;
        WMMainLoading.Show = false;
        StateHasChanged();
        Common.ShowMsg(PopupService, "打开输出文件夹？", "好的", async () =>
        {
            await OpenFolder();
        });
    }

    async Task OpenFolder()
    {
        var path = Global.OutPutPath;
        var psi = new System.Diagnostics.ProcessStartInfo() { FileName = path, UseShellExecute = true };
        System.Diagnostics.Process.Start(psi);
        await Task.CompletedTask;
    }

    Func<string, Task> ClipboardAction = new((x) =>
       {
           System.Windows.Clipboard.SetText(x);
           return Task.CompletedTask;
       });


    async Task InitLogoCacheDic(string imgId, WMTemplateList template)
    {
        var logoes = new List<WMLogo>();
        foreach (var c1 in template.Canvas.Children)
        {
            foreach (var cc1 in c1.Controls)
            {
                if (cc1 is WMLogo logo) logoes.Add(logo);
                else if (cc1 is WMContainer wc)
                {
                    foreach (var wcc in wc.Controls)
                    {
                        if (wcc is WMLogo wcLogo) logoes.Add(wcLogo);
                    }
                }
            }
        }

        var dic = new Dictionary<string, string>();
        var db64 = new ConcurrentDictionary<string, byte[]>();
        foreach (var logo in logoes)
        {
            dic[logo.ID] = logo.Path;
            var target = logo.Path;
            if (!File.Exists(target))
            {
                target = Global.AppPath.TemplatesFolder + template.ID + Path.DirectorySeparatorChar + logo.Path;
            }
            if (File.Exists(target))
            {
                Global.ImageFile2Base64(db64, target, logo.ID);
            }
        }
        foreach (var e in db64)
        {
            LogoBase64[e.Key] = await JSRuntime.InvokeAsync<string>("byteToUrl", e.Value);
        }
        LogoCacheDic[imgId] = dic;

    }

    async Task InitLogoStore()
    {
        LogoStore = new List<string>();
        var db64 = new ConcurrentDictionary<string, byte[]>();
        if (Directory.Exists(Global.AppPath.LogoesFolder))
        {
            var files = new DirectoryInfo(Global.AppPath.LogoesFolder);
            var tasks = new List<Task>();
            foreach (var file in files.GetFiles())
            {
                var t = Task.Run(() =>
                {
                    LogoStore.Add(file.FullName);
                    Global.ImageFile2Base64(db64, file.FullName, file.FullName);
                });
                tasks.Add(t);
            }

            foreach (var e in db64)
            {
                LogoBase64[e.Key] = await JSRuntime.InvokeAsync<string>("byteToUrl", e.Value);
            }
            await Task.WhenAll(tasks.ToArray());
        }
    }

    async void ChangeLogo(string sourceId, string logoPath)
    {
        SrcLoading = true;
        StateHasChanged();
        foreach (var c1 in CurrentImage.Canvas.Children)
        {
            foreach (var cc1 in c1.Controls)
            {
                if (cc1 is WMLogo logo && logo.ID == sourceId)
                {
                    logo.AutoSetLogo = false;
                    logo.Path = logoPath;
                    break;
                }
                else if (cc1 is WMContainer wc)
                {
                    foreach (var wcc in wc.Controls)
                    {
                        if (wcc is WMLogo wcLogo && wcLogo.ID == sourceId)
                        {
                            wcLogo.AutoSetLogo = false;
                            wcLogo.Path = logoPath;
                            break;
                        }
                    }
                }
            }
        }
        var b64 = await helper.GenerationAsync(CurrentImage.Canvas, null, true);
        var src = await JSRuntime.InvokeAsync<string>("byteToUrl", b64);
        CurrentImage.Src = src;
        SrcLoading = false;
        StateHasChanged();
    }

    async void ImportLogoes()
    {
        var dialog = DialogService.Show<Watermark.Razor.Components.LogoDialog>(string.Empty, new DialogOptions() { MaxWidth = MaxWidth.ExtraLarge, NoHeader = true });
        var result = await dialog.Result;
        if (!result.Canceled)
        {
            await InitLogoStore();
        }
    }

    async void ReplaceLogo(string sourceId)
    {
        var dialog = DialogService.Show<Watermark.Razor.Components.LogoDialog>(string.Empty, new DialogOptions() { MaxWidth = MaxWidth.ExtraLarge, NoHeader = true });
        var result = await dialog.Result;
        if (!result.Canceled && result.Data is KeyValuePair<string, string> d)
        {
            var p = Path.Combine(Global.AppPath.LogoesFolder, d.Key);
            ChangeLogo(sourceId, p);
        }
    }


    void EnableAll()
    {
        Common.ShowMsg(PopupService, "当前模板应用全部？", "应用", async () =>
        {
            await Help();
        });
    }

    public async Task Help()
    {
        WMMainLoading.Show = true;
        StateHasChanged();
        int idx = 1;
        foreach (var img in Images)
        {
            WMMainLoading.Message = $"正在应用模板，一共{Images.Count}张，目前第{idx}张";
            WMMainLoading.Value = idx++ * 100.0 / Images.Count;
            StateHasChanged();
            var b64 = await Task.Run(() =>
            {
                var cvs = Global.ReadConfig(Global.CanvasSerialize(CurrentTemplate.Canvas));
                cvs.Exif = img.Canvas.Exif;
                img.Canvas = cvs;
                cvs.Path = img.Path;
                return helper.Generation(cvs, null, true);
            });

            var src = await JSRuntime.InvokeAsync<string>("byteToUrl", b64);
            img.Src = src;
            await InitLogoCacheDic(img.ID, CurrentTemplate);
        }
        WMMainLoading.Value = 100;
        WMMainLoading.Show = false;
        StateHasChanged();
    }

    void OpenLink(string link)
    {
        var action = new Action(() =>
        {
            var psi = new System.Diagnostics.ProcessStartInfo() { FileName = link, UseShellExecute = true };
            System.Diagnostics.Process.Start(psi);
        });
        OpenWinHelper.Open(action);
    }
    Action OpenFolderAction = new Action(() =>
                {
                    Microsoft.Win32.OpenFolderDialog dialog = new();
                    var result = dialog.ShowDialog();

                    if (result == true)
                    {
                        Global.OutPutPath = dialog.FolderName;
                    }
                });

    async void SelectSourceImageExif(IBrowserFile file)
    {
        MemoryStream ms = new MemoryStream();
        await file.OpenReadStream(file.Size).CopyToAsync(ms);
        CurrentImage.Canvas.Exif[CurrentImage.Canvas.ID] = ExifHelper.ReadImage(ms.ToArray());
    }


    async Task InitFonts(List<WMCanvas> mCanvas)
    {
        WMMainLoading.Message = "正在下载字体资源...";
        WMMainLoading.Show = true;
        await Global.InitFonts(mCanvas);
    }

    // async void OpenExifDialog(WMText mText)
    // {
    //     var parameters = new DialogParameters<Watermark.Razor.Components.ExifConfig>();
    //     parameters.Add(x => x.mText, mText);
    //     var dic = CurrentImage.Canvas.Children.Where(x => !x.ContainerProperties.FixImage).ToDictionary((k) => k.ID, v => v.Name);
    //     dic[CurrentImage.Canvas.ID] = CurrentImage.Canvas.Name;
    //     parameters.Add(x => x.ContainerId2Name, dic.Reverse().ToDictionary());
    //     parameters.Add(x => x.CanvasType, CurrentImage.Canvas.CanvasType);
    //     var option = new DialogOptions() { NoHeader = true, MaxWidth = MaxWidth.Medium };
    //     var rst = DialogService.Show<Watermark.Razor.Components.ExifConfig>("", parameters, option);
    //     var dialogResult = await rst.Result;
    //     if (!dialogResult.Canceled)
    //     {
    //         WMText text = (WMText)dialogResult.Data;
    //         mText.Exifs = text.Exifs;
    //         mText.BindedContainerId = text.BindedContainerId;
    //         RefreshImage();
    //         StateHasChanged();
    //     }
    // }

    async void OpenFullExifInfo()
    {
        var parameters = new DialogParameters<ExifInfo>();
        parameters.Add(x => x.Exifs, ExifHelper.ReadAllExif(CurrentImage.Canvas.Exif.FirstOrDefault().Value));
        var option = new DialogOptions() { NoHeader = true, MaxWidth = MaxWidth.Medium };
        var rst = DialogService.Show<ExifInfo>("", parameters, option);
        var dialogResult = await rst.Result;
    }

    async void SelectSplitImages(WMTemplateList template)
    {
        Dictionary<string, Dictionary<string, string>> exif = [];
        exif[template.Canvas.ID] = ExifHelper.DefaultMeta;
        var action = Task.Run(() =>
                {
                    // 实例化一个文件选择对象
                    Microsoft.Win32.OpenFileDialog dialog = new()
                        {
                            DefaultExt = ".jpg",  // 设置默认类型
                            Multiselect = true,                             // 设置可选格式
                            Filter = @"图像文件(*.jpg,*.png)|*jpeg;*.jpg;*.png|JPEG(*.jpeg, *.jpg)|*.jpeg;*.jpg|PNG(*.png)|*.png"

                        };
                    // 打开选择框选择
                    Nullable<bool> result = dialog.ShowDialog();
                    if (result == true)
                    {
                        if (!Directory.Exists(Global.AppPath.ThumbnailFolder))
                        {
                            Directory.CreateDirectory(Global.AppPath.ThumbnailFolder);
                        }

                        int c = 0;
                        foreach (var container in template.Canvas.Children)
                        {
                            if (c <= dialog.FileNames.Length - 1 && !container.ContainerProperties.FixImage)
                            {
                                container.Path = dialog.FileNames[c++];
                                exif[container.ID] = ExifHelper.ReadImage(container.Path);
                            }
                        }
                    }
                });
        await action;

        SrcLoading = true;
        StateHasChanged();
        var cvs = Global.ReadConfig(Global.CanvasSerialize(template.Canvas));
        cvs.Exif = exif;
        var b64 = await helper.GenerationAsync(cvs, null, true, false);
        CurrentImage = new();
        CurrentImage.Canvas = cvs;
        CurrentImage.ID = CurrentImage.Canvas.ID;
        CurrentImage.Src = await JSRuntime.InvokeAsync<string>("byteToUrl", b64);
        await InitLogoCacheDic(CurrentImage.ID, template);
        Images = [];
        Images.Add(CurrentImage);
        SrcLoading = false;
        StateHasChanged();
    }
    Func<Task<string>> CreateNewTemplate = new Func<Task<string>>(async () =>
        {
            var dic = new ConcurrentDictionary<string, byte[]>();
            Microsoft.Win32.OpenFileDialog dialog = new()
                {
                    DefaultExt = ".png",  // 设置默认类型
                    Multiselect = false,                             // 设置可选格式
                    Filter = @"图像文件(*.jpg,*.png)|*jpeg;*.jpg;*.png|JPEG(*.jpeg, *.jpg)|*.jpeg;*.jpg|PNG(*.png)|*.png"
                };
            // 打开选择框选择
            Nullable<bool> result = dialog.ShowDialog();

            if (result == true)
            {
                return dialog.FileName;
            }
            else return "";
        });

    void OpenCommonDialog(string Src)
    {
        CommonDialog.Show = true;
        CommonDialog.Message = Src;
    }

}